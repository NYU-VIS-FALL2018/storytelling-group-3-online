<html>
  <head>
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
      }

		  #Box1,#Box2,#Box3,#Box4 {
			  /* border: 1px solid black; */
        padding: 5px;
        margin: 5px;
		  }

      #Legend1,#Legend2,#Legend3,#Legend4 {
        border: 1px solid black;
        padding: 5px;
        margin-top: 5px;
      }

      .divBox {
        border: 1px solid black;
        width: 1240;
        margin-left: 22%;
        display: flex;
      }
    </style>
    <script src="d3.js"></script>
  </head>
  <body>
    <div class="mainView">
      <div class="divBox">
        <svg id="Box1"></svg>
        <svg id="Legend1"></svg>
      </div>
      <div class="divBox">
        <svg id="Box2"></svg>
        <svg id="Legend2"></svg>
      </div>
      <div class="divBox">
        <svg id="Box3"></svg>
        <svg id="Legend3"></svg>
      </div>
      <div class="divBox">
        <svg id="Box4"></svg>
        <svg id="Legend4"></svg>
      </div>
    </div>
  </body>
  <script>
      let store = {};

      function loadData() {
        return Promise.all([
            d3.csv("epl_league_stats.csv")
        ]).then(datasets => {
            store.data = datasets[0];
            return store;
        })
      }

      function getBoxConfig() {
        // Default values of width and height
        let width = 920;
        let height = 920;
        let container1 = d3.select("#Box1");
        let container2 = d3.select("#Box2");
        let container3 = d3.select("#Box3");
        let container4 = d3.select("#Box4");
        let legendContainer1 = d3.select("#Legend1");
        let legendContainer2 = d3.select("#Legend2");
        let legendContainer3 = d3.select("#Legend3");
        let legendContainer4 = d3.select("#Legend4");

        container1
          .attr("width", width)
          .attr("height", height)
        legendContainer1
          .attr("width", width/3.25)
          .attr("height", height/4)
        container2
          .attr("width", width+50)
          .attr("height", height+50)
        legendContainer2
          .attr("width", width/4)
          .attr("height", height/4)
        container3
          .attr("width", width+50)
          .attr("height", height+50)
        legendContainer3
          .attr("width", width/4)
          .attr("height", height/4)
        container4
          .attr("width", width+50)
          .attr("height", height+50)
        legendContainer4
          .attr("width", width/4)
          .attr("height", height/4)
        return {width, height, container1, container2, container3, container4, legendContainer1, legendContainer2, legendContainer3, legendContainer4}
      }

      function leaguePositionMatrix(container, legendContainer){
        let matrixViz = container.append("g")
                                 .attr("transform", "translate(150,50)")
        let eplStatsSummaryByName = d3.nest()
                                      .key((d)=> { return d.epl_team; })
                                      .rollup((v)=> { return d3.mean(v, (d)=> { return d.season_position; }); })
                                      .entries(store.data);
        eplStatsSummaryByName.sort((x,y)=>{
          return d3.ascending(x.value,y.value);
        })
        console.log(eplStatsSummaryByName);
        let epl_team_list = [];
        let epl_season_list = [];
        eplStatsSummaryByName.forEach((element)=> {
          epl_team_list.push(element.key);
        });
        store.data.forEach((element)=> {
          epl_season_list.push(element.epl_season);
        });
        epl_team_list = Array.from(new Set(epl_team_list));
        epl_season_list = Array.from(new Set(epl_season_list));
        let yScale = d3.scaleBand()
                       .domain(epl_team_list)
                       .range([0,850]);
        let xScale = d3.scaleBand()
                       .domain(epl_season_list)
                       .range([0,750]);
        let xAxis = d3.axisTop(xScale);
        let yAxis = d3.axisLeft(yScale);
        let xAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,50)")
                                  .call(xAxis)
        let yAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,50)")
                                  .call(yAxis)
        let yAxisLabel = container.append("text")
                                  .attr("transform", "translate(70,40)")
                                  .text("Epl Team")
        let xAxisLabel = container.append("text")
                                  .attr("transform", "translate(480,20)")
                                  .text("Epl Season")
        let cScaleTopFour = d3.scaleLinear()
                              .domain([1,2.5,4])
                              .range(["#e5f5e0","#a1d99b","#31a354"])
        let cScaleBottomThree = d3.scaleLinear()
                                  .domain([18,19,20])
                                  .range(["#fee6ce","#fdae6b","#e6550d"])
        matrixViz.selectAll("rect")
                 .data(store.data)
                 .enter()
                 .append("rect")
                 .attr("fill",d=> {
                   if(d.season_position<=4){
                     return cScaleTopFour(d.season_position);
                   }else if(d.season_position>=18){
                     return cScaleBottomThree(d.season_position);
                   }else{
                     return "#D3D3D3";
                   }
                 })
                 .attr("width", xScale.bandwidth())
                 .attr("height", yScale.bandwidth())
                 .attr("y", d=> yScale(d.epl_team))
                 .attr("x", d=> xScale(d.epl_season))
                 .attr("stroke", "#C0C0C0")

        let legendLabel = legendContainer.append("text")
                                         .attr("transform", "translate(90,20)")
                                         .text("Season Position")
        let topFourTeamLegendScale = d3.scaleBand()
                                       .domain(["1","2","3","4"])
                                       .range([0,200]);
        let bottomThreeTeamLegendScale = d3.scaleBand()
                                           .domain(["18","19","20"])
                                           .range([0,200]);
        let topFourTeamLegendAxis = d3.axisTop(topFourTeamLegendScale);
        let bottomThreeTeamLegendAxis = d3.axisTop(bottomThreeTeamLegendScale);
        let topFourTeamLegendAxisGroup = legendContainer.append("g")
                                  .attr("transform", "translate(50,60)")
                                  .call(topFourTeamLegendAxis)
        let bottomThreeTeamLegendAxisGroup = legendContainer.append("g")
                                                            .attr("transform", "translate(50,140)")
                                                            .call(bottomThreeTeamLegendAxis)
        let topFourTeamLegend = legendContainer.append("g")
                                               .attr("transform", "translate(50,60)")
        let bottomThreeTeamLegend = legendContainer.append("g")
                                                   .attr("transform", "translate(50,140)")
        let topFourTeamLegendData = [
          {lp_cat:"1",lp_ord:1},
          {lp_cat:"2",lp_ord:2},
          {lp_cat:"3",lp_ord:3},
          {lp_cat:"4",lp_ord:4}
        ]
        let bottomThreeTeamLegendData = [
          {lp_cat:"18",lp_ord:18},
          {lp_cat:"19",lp_ord:19},
          {lp_cat:"20",lp_ord:20}
        ]
        topFourTeamLegend.selectAll("rect")
                         .data(topFourTeamLegendData)
                         .enter()
                         .append("rect")
                         .attr("fill",d=> cScaleTopFour(d.lp_ord))
                         .attr("width", topFourTeamLegendScale.bandwidth())
                         .attr("height", 30)
                         .attr("x", d=> topFourTeamLegendScale(d.lp_cat))

        bottomThreeTeamLegend.selectAll("rect")
                             .data(bottomThreeTeamLegendData)
                             .enter()
                             .append("rect")
                             .attr("fill",d=> cScaleBottomThree(d.lp_ord))
                             .attr("width", bottomThreeTeamLegendScale.bandwidth())
                             .attr("height", 30)
                             .attr("x", d=> bottomThreeTeamLegendScale(d.lp_cat))
      }

      function winDrawLossStackedBarChart(container, legendContainer, eplseason){
        let winBarChartViz = container.append("g")
                                      .attr("transform", "translate(150,50)")
        let drawBarChartViz = container.append("g")
                                       .attr("transform", "translate(150,50)")
        let lossBarChartViz = container.append("g")
                                       .attr("transform", "translate(150,50)")
        filteredDataBySeason = store.data.filter(d=>{return d.epl_season == eplseason;})
        filteredDataBySeason = filteredDataBySeason.map(d=>{
          d.season_position = +d.season_position;
          d.matches_won = +d.matches_won;
          d.matches_lost = +d.matches_lost;
          d.matches_drawn = +d.matches_drawn;
          return d;
        })
        filteredDataBySeason.sort((x,y)=>{
          return d3.ascending(x.season_position,y.season_position);
        })
        console.log(filteredDataBySeason);
        let epl_team_list = [];
        filteredDataBySeason.forEach((element)=> {
          epl_team_list.push(element.epl_team);
        });
        let maxOfSumOfWinsDrawsLosses = d3.max(filteredDataBySeason, d=> (d.matches_won+d.matches_lost+d.matches_drawn));
        let xScale = d3.scaleLinear()
                       .range([0,800])
                       .domain([0,maxOfSumOfWinsDrawsLosses])
        let yScale = d3.scaleBand()
                       .domain(epl_team_list)
                       .range([0,850])
                       .padding(0.1);
        let xAxis = d3.axisBottom(xScale);
        let yAxis = d3.axisLeft(yScale);
        let xAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,900)")
                                  .call(xAxis)
        let xAxisLabel = container.append("text")
                                  .attr("transform", "translate(500,950)")
                                  .text("Proportion of Wins, Draws & Losses")
        let yAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,50)")
                                  .call(yAxis)
        let yAxisLabel = container.append("text")
                                  .attr("transform", "translate(70,40)")
                                  .text("Epl Team")
        winBarChartViz.selectAll("rect")
                   .data(filteredDataBySeason)
                   .enter()
                   .append("rect")
                   .attr("fill","#7570b3")
                   .attr("width", d=> xScale(d.matches_won))
                   .attr("height", yScale.bandwidth())
                   .attr("y", d=> yScale(d.epl_team))
        drawBarChartViz.selectAll("rect")
                       .data(filteredDataBySeason)
                       .enter()
                       .append("rect")
                       .attr("fill","#d95f02")
                       .attr("width", d=> xScale(d.matches_drawn))
                       .attr("height", yScale.bandwidth())
                       .attr("y", d=> yScale(d.epl_team))
                       .attr("x", d=> xScale(d.matches_won))
        lossBarChartViz.selectAll("rect")
                       .data(filteredDataBySeason)
                       .enter()
                       .append("rect")
                       .attr("fill","#1b9e77")
                       .attr("width", d=> xScale(d.matches_lost))
                       .attr("height", yScale.bandwidth())
                       .attr("y", d=> yScale(d.epl_team))
                       .attr("x", d=> xScale(d.matches_won+d.matches_drawn))
      }

      function goalDifferenceBarChart(container, legendContainer, eplseason){
        let barChartViz = container.append("g")
                                   .attr("transform", "translate(150,50)")
        filteredDataBySeason = store.data.filter(d=>{return d.epl_season == eplseason;})
        filteredDataBySeason = filteredDataBySeason.map(d=>{
          d.season_position = +d.season_position;
          d.goal_difference = +d.goal_difference;
          return d;
        })
        filteredDataBySeason.sort((x,y)=>{
          return d3.ascending(x.season_position,y.season_position);
        })
        console.log(filteredDataBySeason);
        let epl_team_list = [];
        filteredDataBySeason.forEach((element)=> {
          epl_team_list.push(element.epl_team);
        });
        let maxGoalDifference = d3.max(filteredDataBySeason, d=> d.goal_difference);
        let minGoalDifference = d3.min(filteredDataBySeason, d=> d.goal_difference);
        let xScale = d3.scaleLinear()
                       .range([0,800])
                       .domain([minGoalDifference-10,maxGoalDifference+5])
        let positiveGoalDifferenceScale = d3.scaleLinear()
                                            .range([0,480])
                                            .domain([0,(maxGoalDifference+5)])
        let negativeGoalDifferenceScale = d3.scaleLinear()
                                            .range([0,320])
                                            .domain([0,-(minGoalDifference-10)])

        let yScale = d3.scaleBand()
                       .domain(epl_team_list)
                       .range([0,850])
                       .padding(0.1);
        let xAxis = d3.axisBottom(xScale);
        let yAxis = d3.axisLeft(yScale);
        let xAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,900)")
                                  .call(xAxis)
        let xAxisLabel = container.append("text")
                                  .attr("transform", "translate(500,950)")
                                  .text("Goal Difference")
        let yAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,50)")
                                  .call(yAxis)
        let yAxisLabel = container.append("text")
                                  .attr("transform", "translate(70,40)")
                                  .text("Epl Team")
        barChartViz.selectAll("rect")
                   .data(filteredDataBySeason)
                   .enter()
                   .append("rect")
                   .attr("fill","#7570b3")
                   .attr("width", d=>{
                      if(d.goal_difference<0){
                          return negativeGoalDifferenceScale(-d.goal_difference);
                      }
                      else{
                          return positiveGoalDifferenceScale(d.goal_difference);
                      }
                   })
                   .attr("height", yScale.bandwidth())
                   .attr("y", d=> yScale(d.epl_team))
                   .attr("x", d=>{
                      if(d.goal_difference<0){
                          return (xScale(0)-negativeGoalDifferenceScale(-d.goal_difference));
                      }
                      else{
                          return (xScale(0));
                      }
                   })
      }

      function totalPassesBarChart(container, legendContainer, eplseason){
        let barChartViz = container.append("g")
                                   .attr("transform", "translate(150,50)")
        filteredDataBySeason = store.data.filter(d=>{return d.epl_season == eplseason;})
        filteredDataBySeason = filteredDataBySeason.map(d=>{
          d.season_position = +d.season_position;
          d.total_through_balls = +d.total_through_balls;
          d.total_passes = +d.total_passes;
          d.total_long_balls = +d.total_long_balls;
          d.total_crosses = +d.total_crosses;
          d.total_backward_pass = +d.total_backward_pass;
          d.total_passes_completed = d.total_through_balls+d.total_passes+d.total_long_balls+d.total_crosses+d.total_backward_pass;
          return d;
        })
        filteredDataBySeason.sort((x,y)=>{
          return d3.ascending(x.season_position,y.season_position);
        })
        console.log(filteredDataBySeason);
        let epl_team_list = [];
        filteredDataBySeason.forEach((element)=> {
          epl_team_list.push(element.epl_team);
        });
        let maxPassesCompleted = d3.max(filteredDataBySeason, d=> d.total_passes_completed);
        let xScale = d3.scaleLinear()
                       .range([0,800])
                       .domain([0,maxPassesCompleted])
        let yScale = d3.scaleBand()
                       .domain(epl_team_list)
                       .range([0,850])
                       .padding(0.1);
        let xAxis = d3.axisBottom(xScale);
        let yAxis = d3.axisLeft(yScale);
        let xAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,900)")
                                  .call(xAxis)
        let xAxisLabel = container.append("text")
                                  .attr("transform", "translate(500,950)")
                                  .text("Total Passes")
        let yAxisGroup = container.append("g")
                                  .attr("transform", "translate(150,50)")
                                  .call(yAxis)
        let yAxisLabel = container.append("text")
                                  .attr("transform", "translate(70,40)")
                                  .text("Epl Team")
        barChartViz.selectAll("rect")
                   .data(filteredDataBySeason)
                   .enter()
                   .append("rect")
                   .attr("fill","#7570b3")
                   .attr("width", d=> xScale(d.total_passes_completed))
                   .attr("height", yScale.bandwidth())
                   .attr("y", d=> yScale(d.epl_team))
      }

      function drawViz() {
          let config = getBoxConfig();
          leaguePositionMatrix(config.container1, config.legendContainer1);
          winDrawLossStackedBarChart(config.container2, config.legendContainer2, "2006/2007");
          goalDifferenceBarChart(config.container3, config.legendContainer3, "2006/2007");
          totalPassesBarChart(config.container4, config.legendContainer4, "2006/2007");
          console.log(store.data);
      }

      loadData().then(drawViz);
  </script>
</html>
